<script>
    // Helpers
    var request_big_interval = 8;
    var csrftoken;
    var dataset_id;
    var trendDict = {
        increase: "Значение увеличивается",
        decrease: "Значение уменьшается",
        stable: "Значение стабильно"
    }
    function compareReadingsByTimestamp(a, b) {
        var dt_a = getDateFromISO(a.timestamp_packet);
        var dt_b = getDateFromISO(b.timestamp_packet);
        if (dt_a > dt_b) {
            return -1;
        }
        else if (dt_a < dt_b) {
            return 1;
        }
        return 0;
    }
    function obtainDataSetID() {
        dataset_id = $( "#dataSetID" ).val();
    };
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    };
    function requestData(parameters) {
        var temp_parameters = JSON.parse(JSON.stringify(parameters));
        console.log("Requesting");
        if(++request_big_interval == 10) {
            console.log("Big");
            var stDate = new Date();
            stDate.setHours(stDate.getHours() - 12);
            temp_parameters.date_start = stDate.toISOString();
            temp_parameters.max_number = 400;
            request_big_interval = 0;
        }
        $.post("/datacon/display/webapi", {settings: JSON.stringify(temp_parameters)}, processData);
        console.log("Request over");
    };
    function processData(response, status) {
        if (status != "success") {
            return;
        }
        var results = response.tags;
        console.log(response.time_to_obtain);
        for(i=0;i<results.length;i++) {
            results[i] = processResult(results[i], i);
        };
        received_data.tags = results;
    };
    function processResult(result, id) {
        result.readings.sort(compareReadingsByTimestamp);
        var latest = result.readings[0];
        result.display_reading = latest.reading + " " + result.units;
        //TODO: trends
        result.received = getTimeFromNow(latest.timestamp_packet, "Изменилось");
        result.updated = getTimeFromNow(latest.timestamp_receive, "Данные получены");
        result.id = id;
        if(latest.limits != null) {
            result.alert_value = latest.limits.state;
            if(latest.limits.state == "very_high" || latest.limits.result == "very_low") {
                result.alert_state = "danger";
            }
            else if(latest.limits.state != "normal") {
                result.alert_state = "warning";
            }
        }
        return result;
    };

    // VUE.js

    var received_data = {
        tags: []
    }

    Vue.component('datatag-item', {
        props: ['rdg'],
        template: "#datatag-widget",
        delimiters: ["((", "))"]
        });

    var app = new Vue({
        el: '#main-app',
        data: received_data
    });


    // Document readiness handler
    $( document ).ready(function() {
        csrftoken = Cookies.get('csrftoken');
        obtainDataSetID();
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });
        var parameters_small = {
            dataset: dataset_id,
            only_valid: true,
            round_numerics: 2,
            get_limits: 2,
            diag_info: true,
            get_trends: [10800, 86400]
        };
        requestData(parameters_small);
        requestData(parameters_small);
        setInterval(requestData, 30000, parameters_small);
    });
</script>